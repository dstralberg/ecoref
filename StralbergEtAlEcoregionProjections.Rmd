---
title: "Climate-projected distributional shifts and refugia for North American ecoregions"
author: "Diana Stralberg (diana.stralberg@ualberta.ca), AdaptWest Project"
output:
  pdf_document: default
  word_document: default
  html_document: default
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Climate model projections suggest major North American biome shifts in response to anthropogenic climate change (Rehfeldt et al. 2012). Such shifts could have profound influences on native flora and fauna, many of which would have to move long distances to track their climatic niches. To evaluate potential ecosystem changes at a somewhat finer scale, I projected the change in climate space for level III ecoregions (Commission for Environmental Cooperation 1997) as surrogates for multiple associated species and ecological communities. First, I developed a random forest model (Breiman 2001) to predict ecoregion class from bioclimatic variables. I used 10-km interpolated climate data for the 1971-2000 normal period, available from Natural Resources Canada (McKenney et al. 2011)

R Code for this portion follows:

```library(foreign)
library(randomForest)
library(raster)

#eco = project directory
#datLL = data frame of lat-lon sample points for which to extract climate variables ("CECEcoregionSampleLL.csv"")
#cececo = data frame with ecoregion names ("CECecoregions.csv")
#ecolevel3r = ecoregion raster with a Lambert azimuthal equal-area projection ("ceclev3idlaz.tif")
#ecolevel3s = ecoregion shapefile with a Lambert azimuthal equal-area projection ("NA_CEC_Eco_Level3_lazea.shp")
lazea <-  CRS("+proj=laea +lat_0=45 +lon_0=-100 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0")

#cur = directory containing grids representing derived climate variables
setwd(cur)
clim <- list.files(cur, pattern =".asc$")
curclim<-stack(clim)

temp <- raster(clim[1])
ID <- as.data.frame(rasterToPoints(temp))
names(ID)[3] <- "ID4km"
ID$ID <- row.names(ID)
IDR <- raster(ncols=ncol(temp), nrows=nrow(temp), xmn=xmin(temp), xmx=xmax(temp), ymn=ymin(temp), ymx=ymax(temp))
IDRR <- rasterize(as.matrix(ID[,1:2]), IDR, as.numeric(ID[,4]))

curclim <- addLayer(curclim,IDRR)

sampleclim<-cbind(datLL,extract(curclim,as.matrix(cbind(datLL[,3],datLL[,4]))))
sc <- na.omit(sampleclim)
names(sc)[ncol(sc)] <- "IDgrid"
sc$NA_L3CODE <- as.factor(as.character(sc$NA_L3CODE))
lu <- as.data.frame(levels(sc$NA_L3CODE))
lu$level <- row.names(lu)
names(lu)[1] <- "NA_L3CODE"

setwd(eco)
eco.rf <- randomForest(y=sc$NA_L3CODE, x=sc[,5:(ncol(sc)-1)],importance = TRUE, proximity = TRUE, data=sc)
eco1.rf <- randomForest(y=sc$NA_L3CODE, x=sc[,5:23],importance = TRUE, proximity = TRUE, data=sc)
round(importance(eco1.rf), 2)
varImpPlot(eco1.rf) 
ecocurr <- predict(curclim,eco1.rf)
ecocurrlaz <- round(projectRaster(ecocurr, ecolevel3r, method='ngb'),0)
writeRaster(ecocurrlaz,filename="current1_lazea.tif",datatype='INT4S',format="GTiff",overwrite=TRUE)
curfreq <- freq(ecocurrlaz)
ecolu <- merge(lu,curfreq,by.x="level",by.y="value")
names(ecolu)[3] <- "curr"
```

This model was then used to project ecoregions onto future mid-century (2041-2070) and end-of-century (2071-2100) climate conditions. Climate projections were based on 10-km downscaled climate anomalies (McKenney et al. 2011) generated by four widely-used GCMs from the Coupled Model Intercomparison Project, Phase 5 (CMIP5, Taylor et al. 2012): CanESM2, CESM1-CAM5, HadGEM2-ES, and MIROC-ESM. These particular GCMs were selected for downscaling by the Canadian Forest Service based on availability of key variables such as solar radiation, wind speed and humidity, as well as temperature and precipitation to support various forest modeling efforts (McKenney et al., 2013). We used representative concentration pathway (RCP) 8.5, to represent the 21st century conditions that are to be expected without dramatic reductions in greenhouse gas emissions or technological fixes (Fuss et al. 2014).

The following code generates projections for each GCM and time period and reprojects the results to an equal-area projection.

```
#fut = directory containing grids representing derived future climate variables
gcm <- c("canesm2","cesm1cam5","hadgem2es","mirocesm")
rcp <- c("rcp45","rcp85")
time <- c("2041-2070","2071-2100")
for (i in gcm) {
	for (j in rcp) {
		for (k in time) {
			w  <- paste(fut,i,"/",j,"/",k,"/",sep="")
			setwd(w)
			futclim <- list.files(w,pattern=".asc$")
			s <-stack(futclim[1:99])
			p <- predict(s,eco1.rf)
			plaz <- round(projectRaster(p,ecolevel3r,method='ngb'),0)
			writeRaster(plaz, filename=paste(eco,j,k,i,"1",sep="_"),datatype='INT4S',format="GTiff", overwrite=TRUE)
			}
		}	
	}
```	

Next, I identified the most frequently-predicted Level-III ecoregion (Table 1) at each pixel location (i.e, the mode) for RCP 4.5 and RCP 8.5.

```
groups <- c("rcp45_2041-2070","rcp45_2071-2100","rcp85_2041-2070","rcp85_2071-2100")
setwd(eco)
for (i in groups) {
	g <- list.files(eco,pattern=i)
	g1 <- grep(pattern=".tif$",g,value=TRUE)
	gs <- stack(g1)
	m <- overlay(gs, fun = modal)	
	futfreq <- as.data.frame(freq(m))
	names(futfreq)[2] <- i
	ecolu <- merge(ecolu,futfreq,by.x="level",by.y="value")
	writeRaster(m, filename=paste(eco,i,"mode",sep="_"),datatype='INT4S',format="GTiff", overwrite=TRUE)
	}
ecolu1 <- merge(unique(cececo[,c(2:4)]),ecolu[,2:7],by="NA_L3CODE")
write.csv(ecolu1,file="ecoregion_change.summary.csv",row.names=FALSE)
```

![Figure 1. Model-predicted (a) baseline, (b) mid-century, and (c) end-of-century changes in North American ecoregions for RCP 4.5. Boreal and western forested regions are shown in green and blue-green shades; arctic ecoregions are in purple shades; prairie/parkland ecoregions are in red-brown shades; and temperate forest ecoregions are in light green, yellow, and orange shades (see Table 1 for full list of ecoregions). Boreal ecoregions are also outlined in black.](I:/GoogleDrive/COBB_ClimateChange/ACE-ECOResubmission/ecoref/ecoregion_cmip5_RCP45.png)

![Figure 2. Model-predicted (a) baseline, (b) mid-century, and (c) end-of-century changes in North American ecoregions for RCP 8.5. Boreal and western forested regions are shown in green and blue-green shades; arctic ecoregions are in purple shades; prairie/parkland ecoregions are in red-brown shades; and temperate forest ecoregions are in light green, yellow, and orange shades (see Table 1 for full list of ecoregions). Boreal ecoregions are also outlined in black.](I:/GoogleDrive/COBB_ClimateChange/ACE-ECOResubmission/ecoref/ecoregion_cmip5_RCP85.png)

I then calculated the change in area (16 km2 pixels) for each Level III ecoregion:

Table 1. Model-projected changes by ecoregion:

```{r,echo=FALSE}
library(knitr)
ecolu1<-read.csv("I:/GoogleDrive/COBB_ClimateChange/ACE-ECOResubmission/ecoref/ecoregion_change.summary.csv")
kable(ecolu1[,c(1:2,4:8)], digits=2)

```

I also specifically summarized changes for boreal ecoregions (5.4, 5.1, 3.4, 3.3, 3.2, 3.1, and 6.1):

Table 2. Model-projected changes by boreal ecoregion:

```{r,echo=FALSE}
library(knitr)
ecolu1<-read.csv("I:/GoogleDrive/COBB_ClimateChange/ACE-ECOResubmission/ecoref/ecoregion_change.summary.csv")
boreal <- c("5.4","5.1","3.4","3.3","3.2","3.1","6.1")
borealeco <- ecolu1[ecolu1$NA_L2CODE %in% boreal,]
borealsum <- colSums(borealeco[,4:8])
kable(borealeco[,c(1:2,4:8)], digits=2,row.name="FALSE")

```

This translates into 34% and 83% losses of boreal climate space by 2041-2070 and 2071-2100, respectively, based on RCP 8.5; or 27% and 34% losses based on RCP 4.5


**References**

Breiman, L. 2001. Random Forests. Machine Learning 45:5-32.

Commission for Environmental Cooperation. 1997. Ecological Regions of North America: Toward a Common Perspective, Montreal, Canada.

Fuss, S., J. G. Canadell, G. P. Peters, M. Tavoni, R. M. Andrew, P. Ciais, R. B. Jackson, C. D. Jones, F. Kraxner, N. Nakicenovic, C. Le Quere, M. R. Raupach, A. Sharifi, P. Smith, and Y. Yamagata. 2014. Betting on negative emissions. Nature Climate Change 4:850-853.

McKenney, D., J. Pedlar, M. Hutchinson, P. Papadopol, K. Lawrence, K. Campbell, E. Milewska, R. F. Hopkinson, and D. Price. 2013. Spatial climate models for Canada's forestry community. The Forestry Chronicle 89:659-663.

Rehfeldt, G. E., N. L. Crookston, C. Sáenz-Romero, and E. M. Campbell. 2012. North American vegetation model for land-use planning in a changing climate: a solution to large classification problems. Ecological Applications 22:119-141.

Taylor, K. E., R. J. Stouffer, and G. A. Meehl. 2012. An Overview of CMIP5 and the Experiment Design. Bulletin of the American Meteorological Society 93:485-498.


